<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${course != null ? course.title : 'Chi ti·∫øt kh√≥a h·ªçc'}">Chi ti·∫øt kh√≥a h·ªçc</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Quill.js Rich Text Editor -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <!-- üî• Real-time Comments: SockJS and STOMP libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .header-controls {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }

        .back-to-dashboard-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .back-to-dashboard-btn:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            color: white;
            text-decoration: none;
        }

        .back-to-dashboard-btn i {
            font-size: 0.9rem;
        }

        .course-title {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        /* Navigation tabs */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 2rem;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 10px;
        }

        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            border-radius: 10px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .nav-tab.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
        }

        .nav-tab:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateY(-2px);
        }

        /* Main content layout */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 380px;
            gap: 2rem;
        }

        /* Course section */
        .course-section {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .course-header {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border-radius: 15px;
            border: 1px solid rgba(102, 126, 234, 0.2);
        }

        .course-subtitle {
            font-size: 1.2rem;
            color: #4a5568;
            font-weight: 500;
        }

        .start-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1.1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .start-btn.continue {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .controls-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .expand-all {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid rgba(102, 126, 234, 0.2);
            padding: 10px 20px;
            border-radius: 10px;
            color: #667eea;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .expand-all:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }

        .add-lesson-btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .add-lesson-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        /* Module items */
        .module-item {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(102, 126, 234, 0.1);
            border-radius: 15px;
            margin-bottom: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }

        .module-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .module-header {
            display: flex;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .module-header:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
        }

        .module-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid #e2e8f0;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .module-checkbox.completed {
            background: linear-gradient(135deg, #48bb78, #38a169);
            border-color: #48bb78;
            color: white;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.3);
        }

        .module-title {
            flex: 1;
            font-weight: 600;
            font-size: 1.1rem;
            color: #2d3748;
        }

        /* Lesson action buttons */
        .lesson-actions {
            display: flex;
            gap: 8px;
            margin-right: 15px;
        }

        .action-btn {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 8px;
            padding: 8px 10px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .edit-btn {
            color: #667eea;
        }

        .edit-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
            transform: translateY(-1px);
        }

        .delete-btn {
            color: #dc3545;
        }

        .delete-btn:hover {
            background: rgba(220, 53, 69, 0.1);
            border-color: #dc3545;
            transform: translateY(-1px);
        }

        .module-toggle {
            font-size: 20px;
            color: #667eea;
            font-weight: bold;
            transition: transform 0.3s ease;
        }

        .module-content {
            padding: 20px;
            background: rgba(255, 255, 255, 0.5);
            border-top: 1px solid rgba(102, 126, 234, 0.1);
            display: none;
        }

        .module-content.expanded {
            display: block;
        }

        .sub-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
        }

        .sub-item a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .sub-item a:hover {
            color: #764ba2;
            text-decoration: underline;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .sidebar-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 1.5rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #2d3748;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .goals-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 1rem;
        }

        .goal-item {
            text-align: center;
            padding: 15px 10px;
            border: 2px solid rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .goal-item:hover {
            border-color: rgba(102, 126, 234, 0.3);
            background: rgba(102, 126, 234, 0.05);
            transform: translateY(-2px);
        }

        .goal-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .goal-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #2d3748;
        }

        .goal-subtitle {
            font-size: 11px;
            color: #6c757d;
        }

        /* Progress bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 4px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #48bb78, #38a169);
            transition: width 0.3s ease;
            border-radius: 4px;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 1200px;
            max-height: 100vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6c757d;
            transition: color 0.3s ease;
        }

        .close-btn:hover {
            color: #dc3545;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #2d3748;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 2rem;
            padding-top: 1.5rem;
            border-top: 2px solid rgba(102, 126, 234, 0.1);
        }

        .btn-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .btn-cancel:hover {
            background: #545b62;
            transform: translateY(-1px);
        }

        .btn-submit {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-submit:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Empty state */
        .no-lessons-message {
            text-align: center;
            padding: 4rem 2rem;
            color: #6c757d;
        }

        .empty-state {
            max-width: 400px;
            margin: 0 auto;
        }

        .empty-icon {
            font-size: 4rem;
            margin-bottom: 1.5rem;
        }

        .empty-state h3 {
            color: #2d3748;
            margin-bottom: 1rem;
            font-size: 1.5rem;
        }

        .empty-state p {
            font-size: 1rem;
            line-height: 1.6;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                padding: 15px;
            }

            .header-controls {
                margin-bottom: 0.5rem;
            }

            .back-to-dashboard-btn {
                font-size: 12px;
                padding: 8px 12px;
            }

            .back-to-dashboard-btn span {
                display: none;
            }

            .course-title {
                font-size: 1.5rem;
            }

            .nav-tabs {
                overflow-x: auto;
                white-space: nowrap;
            }

            .nav-tab {
                min-width: 120px;
            }

            .main-content {
                flex-direction: column;
            }

            .sidebar {
                order: -1;
                margin-bottom: 20px;
            }
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5a67d8, #6b46c1);
        }

        /* Rich Text Editor Styles */
        .editor-container {
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            overflow: hidden;
            background: white;
        }

        .editor-container .ql-toolbar {
            border: none;
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
            background: rgba(102, 126, 234, 0.05);
        }

        .editor-container .ql-container {
            border: none;
            font-size: 14px;
            min-height: 200px;
        }

        .editor-container .ql-editor {
            min-height: 200px;
            padding: 20px;
        }

        .editor-container .ql-editor.ql-blank::before {
            color: #6c757d;
            font-style: italic;
        }

        /* Video Preview Styles */
        .video-preview-container {
            margin-top: 10px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 10px;
            overflow: hidden;
            background: #f8f9fa;
        }

        .video-preview {
            width: 100%;
            height: 200px;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .video-preview iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .video-preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            color: #6c757d;
        }

        .video-preview-placeholder i {
            font-size: 48px;
        }

        .video-url-input {
            position: relative;
        }

        .video-url-input .form-input {
            padding-right: 50px;
        }

        .video-preview-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .video-preview-btn:hover {
            background: #5a67d8;
        }

        .video-info {
            padding: 10px 15px;
            background: white;
            border-top: 1px solid rgba(102, 126, 234, 0.1);
            font-size: 12px;
            color: #6c757d;
        }

        /* Template buttons */
        .template-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .template-btn {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: #667eea;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .template-btn:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }

        .template-btn i {
            margin-right: 5px;
        }

        /* Comments Section Styles */
        .comments-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .comments-header {
            margin-bottom: 30px;
        }

        .comments-header h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .rating-summary {
            display: flex;
            gap: 40px;
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            align-items: center;
        }

        .average-rating {
            text-align: center;
            min-width: 150px;
        }

        .rating-number {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
            line-height: 1;
        }

        .rating-stars {
            font-size: 20px;
            color: #ffd700;
            margin: 5px 0;
        }

        .rating-count {
            color: #6c757d;
            font-size: 14px;
        }

        .rating-breakdown {
            flex: 1;
        }

        .rating-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 8px;
        }

        .rating-row span:first-child {
            width: 30px;
            font-size: 14px;
            color: #6c757d;
        }

        .rating-bar {
            flex: 1;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }

        .rating-fill {
            height: 100%;
            background: #ffd700;
            width: 0%;
            transition: width 0.3s ease;
        }

        .rating-percent {
            width: 40px;
            text-align: right;
            font-size: 12px;
            color: #6c757d;
        }

        .add-comment-form {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .add-comment-form h3 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 18px;
        }

        .rating-input {
            margin-bottom: 20px;
        }

        .rating-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2d3748;
        }

        .star-rating {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .star-input {
            font-size: 24px;
            color: #e9ecef;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .star-input:hover,
        .star-input.active {
            color: #ffd700;
        }

        .comment-input textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s ease;
        }

        .comment-input textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .submit-comment-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-comment-btn:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .login-prompt {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .login-prompt a {
            color: #667eea;
            text-decoration: none;
        }

        .login-prompt a:hover {
            text-decoration: underline;
        }

        /* Comment Items Styles */
        .comment-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .comment-user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .comment-header strong {
            color: #2d3748;
            font-size: 16px;
        }

        .user-role-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .user-role-badge.teacher {
            background: linear-gradient(135deg, #48bb78, #38a169);
        }

        .user-role-badge.admin {
            background: linear-gradient(135deg, #f56565, #e53e3e);
        }

        .comment-date {
            color: #6c757d;
            font-size: 12px;
        }

        .comment-rating {
            color: #ffd700;
            font-size: 14px;
        }

        .comment-content {
            color: #4a5568;
            line-height: 1.6;
            font-size: 14px;
            margin-bottom: 15px;
        }

        .comment-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comment-meta {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Three-dot menu styles */
        .comment-menu {
            position: relative;
            display: inline-block;
        }

        .menu-toggle {
            background: #667eea !important;
            border: 2px solid #5a67d8 !important;
            cursor: pointer;
            padding: 8px 10px;
            border-radius: 6px;
            color: white !important;
            font-size: 16px;
            transition: all 0.3s ease;
            display: flex !important;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .menu-toggle:hover {
            background: #5a67d8 !important;
            color: white !important;
            transform: translateY(-1px);
        }

        .menu-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            min-width: 140px;
            z-index: 1000;
            display: none;
            margin-top: 5px;
        }

        .menu-dropdown.show {
            display: block;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            cursor: pointer;
            font-size: 14px;
            color: #4a5568;
            transition: background-color 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-weight: 500;
        }

        .menu-item:hover {
            background: #f8f9fa;
        }

        .menu-item:first-child {
            border-radius: 6px 6px 0 0;
        }

        .menu-item:last-child {
            border-radius: 0 0 6px 6px;
        }

        .menu-item.reply {
            color: #667eea;
        }

        .menu-item.reply:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .menu-item.delete {
            color: #dc3545;
        }

        .menu-item.delete:hover {
            background: rgba(220, 53, 69, 0.1);
        }

        .menu-item i {
            font-size: 12px;
            width: 14px;
        }

        .reply-form {
            margin-top: 15px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }

        .reply-form.show {
            display: block;
        }

        .reply-input {
            width: 100%;
            min-height: 60px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            resize: vertical;
            font-family: inherit;
        }

        .reply-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            justify-content: flex-end;
        }

        .reply-cancel, .reply-submit {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }

        .reply-cancel {
            background-color: #f5f5f5;
            color: #666;
        }

        .reply-cancel:hover {
            background-color: #e0e0e0;
        }

        .reply-submit {
            background-color: #007bff;
            color: white;
        }

        .reply-submit:hover {
            background-color: #0056b3;
        }

        .replies-container {
            margin-top: 12px;
            padding-left: 20px;
            border-left: 2px solid #e9ecef;
        }

        .reply-item {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 8px;
        }

        .reply-item .comment-header {
            margin-bottom: 8px;
        }

        .reply-item .comment-user-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .reply-item .comment-date {
            font-size: 11px;
            color: #6c757d;
        }

        .reply-item .comment-content {
            font-size: 13px;
            line-height: 1.4;
            margin-bottom: 0;
        }

        .no-comments {
            text-align: center;
            color: #6c757d;
            font-style: italic;
            padding: 40px;
        }

        .error {
            text-align: center;
            color: #dc3545;
            padding: 20px;
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 8px;
        }

        .loading {
            text-align: center;
            color: #667eea;
            padding: 20px;
        }

        .loading i {
            margin-right: 10px;
        }

        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }
        button {
            position: relative;
            overflow: hidden;
        }

        

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Content Position Selector Styles */
        .content-position-selector {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .setting-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-row label {
            font-weight: 600;
        }

        .setting-row select {
            width: 150px;
        }

        /* Single Question Settings Styles */
        .question-settings {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .setting-row {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-row label {
            font-weight: 600;
        }

        .setting-row select {
            width: 150px;
        }

        

        /* Animations */
        @keyframes slideInFromTop {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
            }
        }

       
        
    </style>
</head>
<body th:data-course-id="${course != null ? course.id : ''}">
<div class="container">
    <!-- Header -->
    <div class="header-controls">
        <a href="#" id="backButton" class="back-to-dashboard-btn">
            <i class="fas fa-arrow-left"></i>
            <span>Quay l·∫°i</span>
        </a>
    </div>
    <div class="header">
        <div th:if="${course != null}">
            <h1 class="course-title" th:text="${course.title}">Ti√™u ƒë·ªÅ kh√≥a h·ªçc</h1>
        </div>
        <div th:unless="${course != null}">
            <h1 class="course-title">Kh√¥ng t√¨m th·∫•y kh√≥a h·ªçc</h1>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
        <button class="nav-tab active"><i class="fas fa-book"></i> Kh√≥a H·ªçc</button>
        <button class="nav-tab"><i class="fas fa-comments"></i> B√¨nh lu·∫≠n</button>
    </div>

    <div class="main-content">
        <!-- Main Course Content -->
        <div class="course-section" id="course-tab">
            <div class="course-header">
                <h2 class="course-subtitle">
                    <span th:if="${currentUser != null and courseStarted}">
                        <i class="fas fa-play-circle"></i> Ti·∫øp t·ª•c h·ªçc t·∫≠p - ƒê√£ ho√†n th√†nh <span th:text="${completedLessons}">0</span>/<span th:text="${totalLessons}">0</span> b√†i h·ªçc
                    </span>
                    <span th:unless="${currentUser != null and courseStarted}">
                        <i class="fas fa-rocket"></i> B·∫Øt ƒë·∫ßu kh√≥a h·ªçc c·ªßa b·∫°n ngay h√¥m nay
                    </span>
                </h2>
                
                <!-- Progress bar -->
                <div th:if="${currentUser != null and courseStarted}" class="progress-bar">
                    <div class="progress-fill" 
                         th:style="'width: ' + ${totalLessons > 0 ? (completedLessons * 100 / totalLessons) : 0} + '%'">
            </div>
            </div>
                
                <div th:if="${currentUser != null}">
                    <a th:href="@{${lessons != null and !lessons.isEmpty() ? '/lessons/' + lessons[0].id : '/courses/' + course.id + '/start'}}" 
                       th:class="${courseStarted ? 'start-btn continue' : 'start-btn'}"
                       th:text="${courseStarted ? 'Ti·∫øp t·ª•c kh√≥a h·ªçc' : 'B·∫Øt ƒë·∫ßu kh√≥a h·ªçc'}">
                        <i class="fas fa-play"></i> B·∫Øt ƒë·∫ßu kh√≥a h·ªçc
                    </a>
                </div>
                <div th:unless="${currentUser != null}">
                    <a href="/login" class="start-btn">
                        <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p ƒë·ªÉ h·ªçc
                    </a>
                </div>
            </div>

            <div class="controls-section">
                <button class="expand-all">
                    <i class="fas fa-expand-arrows-alt"></i> M·ªü r·ªông t·∫•t c·∫£
                </button>
                <!-- N√∫t th√™m b√†i h·ªçc cho TEACHER v√† ADMIN -->
                <button th:if="${currentUser != null and (currentUser.role.name() == 'TEACHER' or currentUser.role.name() == 'ADMIN')}" 
                        class="add-lesson-btn" onclick="showAddLessonModal()">
                    <i class="fas fa-plus"></i> Th√™m b√†i h·ªçc
                </button>
            </div>

            <div class="module-item" th:each="lesson : ${lessons}">
                <div class="module-header" onclick="toggleModule(this)">
                    <div th:class="${completedLessonIds != null and completedLessonIds.contains(lesson.id) ? 'module-checkbox completed' : 'module-checkbox'}">
                        <i th:if="${completedLessonIds != null and completedLessonIds.contains(lesson.id)}" class="fas fa-check"></i>
                    </div>
                    <div class="module-title" th:text="${lesson.title}">T√™n b√†i h·ªçc</div>
                    <!-- Action buttons for TEACHER and ADMIN -->
                    <div th:if="${currentUser != null and (currentUser.role.name() == 'TEACHER' or currentUser.role.name() == 'ADMIN')}" 
                         class="lesson-actions" onclick="event.stopPropagation()">
                    
                        <button class="action-btn edit-btn" 
                                th:data-lesson-id="${lesson.id}"
                                th:data-lesson-title="${lesson.title}"
                                th:data-lesson-description="${lesson.description}"
                                th:data-lesson-content="${lesson.contentHtml}"
                                th:data-lesson-video="${lesson.videoUrl}"
                                onclick="showEditLessonModalFromData(this)">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete-btn" 
                                th:data-lesson-id="${lesson.id}"
                                th:data-lesson-title="${lesson.title}"
                                onclick="deleteLessonFromData(this)">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="module-toggle">‚àí</div>
                </div>
                <div class="module-content expanded">
                    <div class="sub-item" th:if="${currentUser != null and courseStarted}">
                        <i class="fas fa-book-open" style="margin-right: 10px; color: #667eea;"></i>
                        <a th:href="@{'/lessons/' + ${lesson.id}}">Xem chi ti·∫øt b√†i h·ªçc</a>
                    </div>
                    <div class="sub-item" th:unless="${currentUser != null and courseStarted}">
                        <i class="fas fa-lock" style="margin-right: 10px; color: #6c757d;"></i>
                        <span class="text-muted">C·∫ßn b·∫Øt ƒë·∫ßu kh√≥a h·ªçc ƒë·ªÉ truy c·∫≠p b√†i h·ªçc</span>
                    </div>
                </div>
            </div>

            <!-- Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu kh√¥ng c√≥ b√†i h·ªçc -->
            <div th:if="${lessons == null or lessons.isEmpty()}" class="no-lessons-message">
                <div class="empty-state">
                    <div class="empty-icon">üìö</div>
                    <h3>Ch∆∞a c√≥ b√†i h·ªçc n√†o</h3>
                    <p>Kh√≥a h·ªçc n√†y hi·ªán ch∆∞a c√≥ b√†i h·ªçc. Vui l√≤ng quay l·∫°i sau ho·∫∑c li√™n h·ªá v·ªõi gi·∫£ng vi√™n.</p>
                </div>
                </div>
            </div>

        <!-- Comments Section -->
        <div class="course-section" id="comments-tab" style="display: none;">
            <div class="comments-container">
                <div class="comments-header">
                    <h2><i class="fas fa-comments"></i> ƒê√°nh gi√° v√† b√¨nh lu·∫≠n</h2>
                    <div class="rating-summary" id="rating-summary">
                        <div class="average-rating">
                            <div class="rating-number">0.0</div>
                            <div class="rating-stars">
                                <span class="star">‚òÖ</span>
                                <span class="star">‚òÖ</span>
                                <span class="star">‚òÖ</span>
                                <span class="star">‚òÖ</span>
                                <span class="star">‚òÖ</span>
                            </div>
                            <div class="rating-count">0 ƒë√°nh gi√°</div>
                        </div>
                        <div class="rating-breakdown">
                            <div class="rating-row">
                                <span>5 ‚òÖ</span>
                                <div class="rating-bar">
                                    <div class="rating-fill" data-rating="5"></div>
                                </div>
                                <span class="rating-percent">0%</span>
                            </div>
                            <div class="rating-row">
                                <span>4 ‚òÖ</span>
                                <div class="rating-bar">
                                    <div class="rating-fill" data-rating="4"></div>
                                </div>
                                <span class="rating-percent">0%</span>
                            </div>
                            <div class="rating-row">
                                <span>3 ‚òÖ</span>
                                <div class="rating-bar">
                                    <div class="rating-fill" data-rating="3"></div>
                                </div>
                                <span class="rating-percent">0%</span>
                            </div>
                            <div class="rating-row">
                                <span>2 ‚òÖ</span>
                                <div class="rating-bar">
                                    <div class="rating-fill" data-rating="2"></div>
                                </div>
                                <span class="rating-percent">0%</span>
                            </div>
                            <div class="rating-row">
                                <span>1 ‚òÖ</span>
                                <div class="rating-bar">
                                    <div class="rating-fill" data-rating="1"></div>
                                </div>
                                <span class="rating-percent">0%</span>
                            </div>
                        </div>
                </div>
            </div>

                <!-- Add Comment Form -->
                <div th:if="${currentUser != null}" class="add-comment-form">
                    <h3>Vi·∫øt ƒë√°nh gi√° c·ªßa b·∫°n</h3>
                    <form id="comment-form" onsubmit="submitComment(event)">
                        <div class="rating-input">
                            <label>ƒê√°nh gi√°:</label>
                            <div class="star-rating">
                                <span class="star-input" data-rating="1">‚òÖ</span>
                                <span class="star-input" data-rating="2">‚òÖ</span>
                                <span class="star-input" data-rating="3">‚òÖ</span>
                                <span class="star-input" data-rating="4">‚òÖ</span>
                                <span class="star-input" data-rating="5">‚òÖ</span>
                </div>
                            <input type="hidden" id="rating-value" name="rating" value="0">
                        </div>
                        <div class="comment-input">
                            <textarea id="comment-content" name="content" placeholder="Chia s·∫ª tr·∫£i nghi·ªám c·ªßa b·∫°n v·ªÅ kh√≥a h·ªçc n√†y..." required></textarea>
                        </div>
                        <button type="submit" class="submit-comment-btn">
                            <i class="fas fa-paper-plane"></i> G·ª≠i ƒë√°nh gi√°
                        </button>
                    </form>
                </div>
                
                <div th:unless="${currentUser != null}" class="login-prompt">
                    <p><i class="fas fa-sign-in-alt"></i> <a href="/login">ƒêƒÉng nh·∫≠p</a> ƒë·ªÉ vi·∫øt ƒë√°nh gi√° v√† b√¨nh lu·∫≠n</p>
                </div>
                
                <!-- Comments List -->
                <div class="comments-list" id="comments-list">
                    <div class="loading" id="comments-loading">
                        <i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i b√¨nh lu·∫≠n...
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Learning Goals -->
            <div class="sidebar-card">
                <h3 class="sidebar-title"><i class="fas fa-target"></i> ƒê·∫°t m·ª•c ti√™u h·ªçc t·∫≠p h√†ng tu·∫ßn</h3>
                <p class="sidebar-text">ƒê·∫°t m·ª•c ti√™u th√∫c ƒë·∫©y b·∫°n ho√†n th√†nh kh√≥a h·ªçc. B·∫°n c√≥ th·ªÉ thay ƒë·ªïi n√≥ sau.</p>

                <div class="goals-grid">
                    <div class="goal-item">
                        <div class="goal-icon">üìö</div>
                        <div class="goal-title">B√¨nh th∆∞·ªùng</div>
                        <div class="goal-subtitle">1 bu·ªïi m·ªôt tu·∫ßn</div>
                    </div>
                    <div class="goal-item">
                        <div class="goal-icon">‚ö°</div>
                        <div class="goal-title">Th∆∞·ªùng xuy√™n</div>
                        <div class="goal-subtitle">3 bu·ªïi m·ªôt tu·∫ßn</div>
                    </div>
                    <div class="goal-item">
                        <div class="goal-icon">üî•</div>
                        <div class="goal-title">R·∫•t chƒÉm ch·ªâ</div>
                        <div class="goal-subtitle">5 bu·ªïi m·ªôt tu·∫ßn</div>
                    </div>
                </div>
            </div>

            <!-- Course Tools -->
            <div class="sidebar-card">
                <h3 class="sidebar-title"><i class="fas fa-tools"></i> C√¥ng c·ª• Kh√≥a h·ªçc</h3>
                <div class="progress-item">
                    <i class="fas fa-arrow-up" style="color: #667eea; margin-right: 10px;"></i>
                    <span class="link-blue">ƒê·∫ßu trang</span>
                </div>
            </div>

          

            <!-- Course Materials -->
            <div class="sidebar-card">
                <h3 class="sidebar-title"><i class="fas fa-folder"></i> T√†i li·ªáu kh√≥a h·ªçc</h3>
                <p style="color: #6c757d; font-size: 14px;">Ch∆∞a c√≥ t√†i li·ªáu n√†o ƒë∆∞·ª£c th√™m v√†o kh√≥a h·ªçc n√†y.</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal th√™m b√†i h·ªçc -->
<div id="addLessonModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-plus-circle"></i> Th√™m b√†i h·ªçc m·ªõi</h3>
            <button class="close-btn" onclick="hideAddLessonModal()">&times;</button>
        </div>
        
        <form id="addLessonForm" onsubmit="submitLesson(event)">
            <div class="form-group">
                <label class="form-label" for="lessonTitle"><i class="fas fa-heading"></i> Ti√™u ƒë·ªÅ b√†i h·ªçc *</label>
                <input type="text" id="lessonTitle" name="title" class="form-input" required 
                       placeholder="Nh·∫≠p ti√™u ƒë·ªÅ b√†i h·ªçc...">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="lessonDescription"><i class="fas fa-align-left"></i> M√¥ t·∫£ b√†i h·ªçc</label>
                <textarea id="lessonDescription" name="description" class="form-input form-textarea" 
                          placeholder="Nh·∫≠p m√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ b√†i h·ªçc..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label"><i class="fas fa-edit"></i> N·ªôi dung b√†i h·ªçc</label>
                
                <!-- Template buttons -->
                <div class="template-buttons">
                    <button type="button" class="template-btn" onclick="insertTemplate('lesson')">
                        <i class="fas fa-book"></i> B√†i h·ªçc c∆° b·∫£n
                    </button>
                 
                   
                    <button type="button" class="template-btn" onclick="insertTemplate('code')">
                        <i class="fas fa-code"></i> Code example
                    </button>
                </div>
                
                <!-- Rich Text Editor -->
                <div class="editor-container">
                    <div id="lessonContentEditor"></div>
                </div>
                <input type="hidden" id="lessonContentHidden" name="contentHtml">
                
                <small style="color: #6c757d; font-size: 12px; margin-top: 10px; display: block;">
                    <i class="fas fa-info-circle"></i> S·ª≠ d·ª•ng thanh c√¥ng c·ª• ƒë·ªÉ ƒë·ªãnh d·∫°ng n·ªôi dung. B·∫°n c√≥ th·ªÉ th√™m ti√™u ƒë·ªÅ, danh s√°ch, li√™n k·∫øt, h√¨nh ·∫£nh v√† nhi·ªÅu h∆°n n·ªØa.
                </small>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="lessonVideoUrl"><i class="fas fa-video"></i> Link video (t√πy ch·ªçn)</label>
                <div class="video-url-input">
                    <input type="url" id="lessonVideoUrl" name="videoUrl" class="form-input" 
                           placeholder="https://youtube.com/watch?v=... ho·∫∑c https://vimeo.com/...">
                    <button type="button" class="video-preview-btn" onclick="previewVideo('lessonVideoUrl', 'addVideoPreview')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                
                <!-- Video Preview -->
                <div id="addVideoPreview" class="video-preview-container" style="display: none;">
                    <div class="video-preview">
                        <div class="video-preview-placeholder">
                            <i class="fas fa-video"></i>
                            <span>Video preview s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</span>
                        </div>
                    </div>
                    <div class="video-info">
                        <i class="fas fa-info-circle"></i> H·ªó tr·ª£ YouTube, Vimeo v√† c√°c link video tr·ª±c ti·∫øp
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="hideAddLessonModal()">
                    <i class="fas fa-times"></i> H·ªßy
                </button>
                <button type="submit" class="btn-submit" id="submitBtn">
                    <i class="fas fa-save"></i> T·∫°o b√†i h·ªçc
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Modal ch·ªânh s·ª≠a b√†i h·ªçc -->
<div id="editLessonModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title"><i class="fas fa-edit"></i> Ch·ªânh s·ª≠a b√†i h·ªçc</h3>
            <button class="close-btn" onclick="hideEditLessonModal()">&times;</button>
        </div>
        
        <form id="editLessonForm" onsubmit="updateLesson(event)">
            <input type="hidden" id="editLessonId" name="lessonId">
            
            <div class="form-group">
                <label class="form-label" for="editLessonTitle"><i class="fas fa-heading"></i> Ti√™u ƒë·ªÅ b√†i h·ªçc *</label>
                <input type="text" id="editLessonTitle" name="title" class="form-input" required 
                       placeholder="Nh·∫≠p ti√™u ƒë·ªÅ b√†i h·ªçc...">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="editLessonDescription"><i class="fas fa-align-left"></i> M√¥ t·∫£ b√†i h·ªçc</label>
                <textarea id="editLessonDescription" name="description" class="form-input form-textarea" 
                          placeholder="Nh·∫≠p m√¥ t·∫£ ng·∫Øn g·ªçn v·ªÅ b√†i h·ªçc..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="form-label"><i class="fas fa-edit"></i> N·ªôi dung b√†i h·ªçc</label>
                
                <!-- Template buttons -->
                <div class="template-buttons">
                    <button type="button" class="template-btn" onclick="insertTemplate('lesson', 'edit')">
                        <i class="fas fa-book"></i> B√†i h·ªçc c∆° b·∫£n
                    </button>
                 
                  
                    <button type="button" class="template-btn" onclick="insertTemplate('code', 'edit')">
                        <i class="fas fa-code"></i> Code example
                    </button>
                </div>
                
                <!-- Rich Text Editor -->
                <div class="editor-container">
                    <div id="editLessonContentEditor"></div>
                </div>
                <input type="hidden" id="editLessonContentHidden" name="contentHtml">
                
                <small style="color: #6c757d; font-size: 12px; margin-top: 10px; display: block;">
                    <i class="fas fa-info-circle"></i> S·ª≠ d·ª•ng thanh c√¥ng c·ª• ƒë·ªÉ ƒë·ªãnh d·∫°ng n·ªôi dung. B·∫°n c√≥ th·ªÉ th√™m ti√™u ƒë·ªÅ, danh s√°ch, li√™n k·∫øt, h√¨nh ·∫£nh v√† nhi·ªÅu h∆°n n·ªØa.
                </small>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="editLessonVideoUrl"><i class="fas fa-video"></i> Link video (t√πy ch·ªçn)</label>
                <div class="video-url-input">
                    <input type="url" id="editLessonVideoUrl" name="videoUrl" class="form-input" 
                           placeholder="https://youtube.com/watch?v=... ho·∫∑c https://vimeo.com/...">
                    <button type="button" class="video-preview-btn" onclick="previewVideo('editLessonVideoUrl', 'editVideoPreview')">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                
                <!-- Video Preview -->
                <div id="editVideoPreview" class="video-preview-container" style="display: none;">
                    <div class="video-preview">
                        <div class="video-preview-placeholder">
                            <i class="fas fa-video"></i>
                            <span>Video preview s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y</span>
                        </div>
                    </div>
                    <div class="video-info">
                        <i class="fas fa-info-circle"></i> H·ªó tr·ª£ YouTube, Vimeo v√† c√°c link video tr·ª±c ti·∫øp
                    </div>
                </div>
            </div>
            
            <div class="form-actions">
                <button type="button" class="btn-cancel" onclick="hideEditLessonModal()">
                    <i class="fas fa-times"></i> H·ªßy
                </button>
                <button type="submit" class="btn-submit" id="updateBtn">
                    <i class="fas fa-save"></i> C·∫≠p nh·∫≠t b√†i h·ªçc
                </button>
            </div>
        </form>
    </div>
</div>



<script>
    // Global variables from Thymeleaf - Fixed initialization
    let currentUserRole = /*[[${currentUser != null ? currentUser.role.name() : 'GUEST'}]]*/ 'GUEST';
    let isUserLoggedIn = /*[[${currentUser != null}]]*/ false;
    let currentUserId = /*[[${currentUser != null ? currentUser.id : 0}]]*/ 0;
    
    console.log('üîç Initial global user info:', {
        role: currentUserRole,
        loggedIn: isUserLoggedIn,
        userId: currentUserId
    });

    // Check authentication status from server
    async function checkAuthStatus() {
        try {
            const response = await fetch('/api/auth/check', {
                credentials: 'include'
            });
            
            if (response.ok) {
                const authData = await response.json();
                console.log('üîç Auth check response:', authData);
                
                if (authData.authenticated) {
                    isUserLoggedIn = true;
                    currentUserRole = authData.role || 'GUEST';
                    currentUserId = authData.userId || 0;
                    
                    console.log('‚úÖ User authenticated via API:', {
                        role: currentUserRole,
                        loggedIn: isUserLoggedIn,
                        userId: currentUserId
                    });
            } else {
                    console.log('‚ùå User not authenticated');
            }
        }
        } catch (error) {
            console.error('Error checking auth status:', error);
    }
    }

    // Check auth on page load
    document.addEventListener('DOMContentLoaded', function() {
        checkAuthStatus();
    });

    // Tab functionality
    let currentRating = 0;

    // Rich Text Editor instances
    let addLessonQuill = null;
    let editLessonQuill = null;

    // Initialize Quill editors when DOM is loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Quill editors
        initializeQuillEditors();
        
        // Add event listeners for video URL inputs to handle real-time preview updates
        const addVideoInput = document.getElementById('lessonVideoUrl');
        const editVideoInput = document.getElementById('editLessonVideoUrl');
        
        if (addVideoInput) {
            addVideoInput.addEventListener('input', function() {
                previewVideo('lessonVideoUrl', 'addVideoPreview');
            });
            
            addVideoInput.addEventListener('blur', function() {
                previewVideo('lessonVideoUrl', 'addVideoPreview');
            });
        }
        
        if (editVideoInput) {
            editVideoInput.addEventListener('input', function() {
                previewVideo('editLessonVideoUrl', 'editVideoPreview');
            });
            
            editVideoInput.addEventListener('blur', function() {
                previewVideo('editLessonVideoUrl', 'editVideoPreview');
            });
        }

        // Tab switching functionality
        const navTabs = document.querySelectorAll('.nav-tab');
        const courseTab = document.getElementById('course-tab');
        const commentsTab = document.getElementById('comments-tab');

        navTabs.forEach((tab, index) => {
        tab.addEventListener('click', function() {
                // Remove active class from all tabs
                navTabs.forEach(t => t.classList.remove('active'));
                // Add active class to clicked tab
            this.classList.add('active');

                // Show/hide content based on tab
                if (index === 0) {
                    // Course tab
                    courseTab.style.display = 'block';
                    commentsTab.style.display = 'none';
                } else {
                    // Comments tab
                    courseTab.style.display = 'none';
                    commentsTab.style.display = 'block';
                    // Load comments when switching to comments tab with auth check
                    setTimeout(async () => {
                        await checkAuthStatus(); // Ensure auth is checked
                        loadComments();
                        loadRatingStats();
                    }, 100);
                }
            });
        });

        // Star rating functionality
        const starInputs = document.querySelectorAll('.star-input');
        starInputs.forEach((star, index) => {
            star.addEventListener('click', function() {
                currentRating = index + 1;
                document.getElementById('rating-value').value = currentRating;
                updateStarDisplay(starInputs, currentRating);
            });

            star.addEventListener('mouseenter', function() {
                updateStarDisplay(starInputs, index + 1);
            });
        });

        const starRating = document.querySelector('.star-rating');
        if (starRating) {
            starRating.addEventListener('mouseleave', function() {
                updateStarDisplay(starInputs, currentRating);
            });
        }

        // Back button functionality
        const backButton = document.getElementById('backButton');
        if (backButton) {
            backButton.addEventListener('click', function(e) {
                e.preventDefault();
                
                console.log('Back button clicked');
                
                // Method 1: Try to get the stored referrer URL
                const referrerUrl = localStorage.getItem('courseReferrer');
                console.log('Stored courseReferrer:', referrerUrl);
                
                // Method 2: Check if we can use browser history
                const canGoBack = window.history.length > 1;
                console.log('Can go back in history:', canGoBack);
                
                // Method 3: Check document.referrer
                const documentReferrer = document.referrer;
                console.log('Document referrer:', documentReferrer);
                
                if (referrerUrl && referrerUrl !== window.location.href) {
                    // Clear the stored referrer and go back to the original page
                    console.log('Using stored referrer URL');
                    localStorage.removeItem('courseReferrer');
                    window.location.href = referrerUrl;
                } else if (documentReferrer && 
                          documentReferrer !== window.location.href && 
                          !documentReferrer.includes('/login') && 
                          !documentReferrer.includes('/register')) {
                    // Use document.referrer if it's valid and not login/register page
                    console.log('Using document referrer');
                    window.location.href = documentReferrer;
                } else if (canGoBack) {
                    // Try to go back in browser history
                    console.log('Using browser history back');
                    window.history.back();
                } else {
                    // Final fallback - go to courses page instead of dashboard
                    console.log('Using fallback - going to courses page');
                    window.location.href = '/courses';
                }
            });
        }
    });

    // Add CSS for ripple effect
    const rippleStyle = document.createElement('style');
    rippleStyle.textContent = `
        @keyframes ripple {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        .ripple {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.6);
            transform: scale(0);
            animation: ripple 0.6s linear;
            pointer-events: none;
        }
        button {
            position: relative;
            overflow: hidden;
        }
    `;
    document.head.appendChild(rippleStyle);


    function updateStarDisplay(stars, rating) {
        stars.forEach((star, index) => {
            if (index < rating) {
                star.classList.add('active');
            } else {
                star.classList.remove('active');
            }
        });
    }

    // Modal functions
    function showAddLessonModal() {
        document.getElementById('addLessonModal').classList.add('show');
        document.body.style.overflow = 'hidden';
        
        // Initialize editor if not already done
        if (!addLessonQuill) {
            setTimeout(() => {
                initializeQuillEditors();
            }, 100);
        }
    }

    function hideAddLessonModal() {
        document.getElementById('addLessonModal').classList.remove('show');
        document.body.style.overflow = 'auto';
        // Reset form and editor
        document.getElementById('addLessonForm').reset();
        if (addLessonQuill) {
            addLessonQuill.setContents([]);
        }
        // Hide video preview
        document.getElementById('addVideoPreview').style.display = 'none';
    }

    // Edit lesson modal functions
    function showEditLessonModal(lessonId, title, description, contentHtml, videoUrl) {
        // Handle null/undefined values
        title = title || '';
        description = description || '';
        contentHtml = contentHtml || '';
        videoUrl = videoUrl || '';
        
        // Set form values
        document.getElementById('editLessonId').value = lessonId;
        document.getElementById('editLessonTitle').value = title;
        document.getElementById('editLessonDescription').value = description;
        document.getElementById('editLessonVideoUrl').value = videoUrl;
        
        // Show modal
        document.getElementById('editLessonModal').classList.add('show');
        document.body.style.overflow = 'hidden';
        
        // Initialize editor if not already done and set content
        if (!editLessonQuill) {
            setTimeout(() => {
                initializeQuillEditors();
                if (editLessonQuill && contentHtml) {
                    editLessonQuill.root.innerHTML = contentHtml;
                }
                // Only preview video if URL exists and is not empty
                if (videoUrl && videoUrl.trim() !== '') {
                    previewVideo('editLessonVideoUrl', 'editVideoPreview');
                } else {
                    // Hide video preview if no URL
                    document.getElementById('editVideoPreview').style.display = 'none';
                }
            }, 100);
        } else {
            if (contentHtml) {
                editLessonQuill.root.innerHTML = contentHtml;
            } else {
                editLessonQuill.setContents([]);
            }
            // Only preview video if URL exists and is not empty
            if (videoUrl && videoUrl.trim() !== '') {
                previewVideo('editLessonVideoUrl', 'editVideoPreview');
            } else {
                // Hide video preview if no URL
                document.getElementById('editVideoPreview').style.display = 'none';
            }
        }
    }

    // Helper function to show edit modal from data attributes
    function showEditLessonModalFromData(button) {
        const lessonId = button.dataset.lessonId;
        const title = button.dataset.lessonTitle || '';
        const description = button.dataset.lessonDescription || '';
        const contentHtml = button.dataset.lessonContent || '';
        const videoUrl = button.dataset.lessonVideo || '';
        
        showEditLessonModal(lessonId, title, description, contentHtml, videoUrl);
    }

    // Helper function to delete lesson from data attributes
    function deleteLessonFromData(button) {
        const lessonId = button.dataset.lessonId;
        const lessonTitle = button.dataset.lessonTitle || 'B√†i h·ªçc';
        
        deleteLesson(lessonId, lessonTitle);
    }

    function hideEditLessonModal() {
        document.getElementById('editLessonModal').classList.remove('show');
        document.body.style.overflow = 'auto';
        // Reset form and editor
        document.getElementById('editLessonForm').reset();
        if (editLessonQuill) {
            editLessonQuill.setContents([]);
        }
        // Hide video preview
        document.getElementById('editVideoPreview').style.display = 'none';
    }

    // Delete lesson function
    async function deleteLesson(lessonId, lessonTitle) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i h·ªçc "${lessonTitle}"?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
            return;
        }
        
        console.log('üóëÔ∏è Deleting lesson:', lessonId);
        
        try {
            // Check authentication
            const authCheck = await fetch('/api/auth/check');
            const authStatus = await authCheck.json();
            
            if (!authStatus.authenticated) {
                throw new Error('B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p ho·∫∑c phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n');
            }
            
            // Get JWT token
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            }

            const authToken = getCookie('auth_token');
            const headers = {};

            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            console.log('Making DELETE request to:', `/api/lessons/${lessonId}`);
            const response = await fetch(`/api/lessons/${lessonId}`, {
                method: 'DELETE',
                headers: headers
            });

            if (response.ok) {
                console.log('Lesson deleted successfully');
                // alert('üóëÔ∏è B√†i h·ªçc ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!');
                window.location.reload();
            } else {
                const errorText = await response.text();
                console.error('Error response:', errorText);
                let errorMessage = 'C√≥ l·ªói x·∫£y ra khi x√≥a b√†i h·ªçc';
                
                try {
                    const errorData = JSON.parse(errorText);
                    errorMessage = errorData.error || errorData.message || errorMessage;
                } catch (e) {
                    errorMessage = errorText || errorMessage;
                }
                
                throw new Error(errorMessage);
            }
        } catch (error) {
            console.error('Error deleting lesson:', error);
            alert('‚ùå L·ªói: ' + error.message);
        }
    }

    function initializeQuillEditors() {
        // Configuration for Quill editor
        const quillConfig = {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                    ['bold', 'italic', 'underline', 'strike'],
                    [{ 'color': [] }, { 'background': [] }],
                    [{ 'script': 'sub'}, { 'script': 'super' }],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    [{ 'indent': '-1'}, { 'indent': '+1' }],
                    [{ 'align': [] }],
                    ['blockquote', 'code-block'],
                    ['link', 'image', 'video'],
                    ['clean']
                ]
            },
            placeholder: 'Nh·∫≠p n·ªôi dung b√†i h·ªçc c·ªßa b·∫°n ·ªü ƒë√¢y...'
        };

        // Initialize Add Lesson Editor
        if (document.getElementById('lessonContentEditor')) {
            addLessonQuill = new Quill('#lessonContentEditor', quillConfig);
        }

        // Initialize Edit Lesson Editor
        if (document.getElementById('editLessonContentEditor')) {
            editLessonQuill = new Quill('#editLessonContentEditor', quillConfig);
        }
    }

    // Template insertion function
    function insertTemplate(type, mode = 'add') {
     
        
        const templates = {
            lesson: `
                <h1>Ti√™u ƒë·ªÅ b√†i h·ªçc</h1>
                <h2>M·ª•c ti√™u h·ªçc t·∫≠p</h2>
                <ul>
                    <li>M·ª•c ti√™u 1</li>
                    <li>M·ª•c ti√™u 2</li>
                    <li>M·ª•c ti√™u 3</li>
                </ul>
                
                <h2>N·ªôi dung ch√≠nh</h2>
                <p>Nh·∫≠p n·ªôi dung b√†i h·ªçc c·ªßa b·∫°n ·ªü ƒë√¢y...</p>
                
                <h3>V√≠ d·ª• minh h·ªça</h3>
                <p>Th√™m v√≠ d·ª• c·ª• th·ªÉ ƒë·ªÉ h·ªçc vi√™n d·ªÖ hi·ªÉu...</p>
                
                <h2>T√≥m t·∫Øt</h2>
                <p>T√≥m t·∫Øt nh·ªØng ƒëi·ªÉm ch√≠nh c·ªßa b√†i h·ªçc...</p>
            `,
            code: `
                <h1>V√≠ d·ª• Code</h1>
                <h2>M√¥ t·∫£</h2>
                <p>M√¥ t·∫£ v·ªÅ ƒëo·∫°n code n√†y...</p>
                
                <h2>Code</h2>
                <pre><code>// Nh·∫≠p code c·ªßa b·∫°n ·ªü ƒë√¢y
function example() {
    console.log("Hello, World!");
}

example();</code></pre>
                
                <h2>Gi·∫£i th√≠ch</h2>
                <p>Gi·∫£i th√≠ch t·ª´ng ph·∫ßn c·ªßa code...</p>
                
                <h2>K·∫øt qu·∫£</h2>
                <p>M√¥ t·∫£ k·∫øt qu·∫£ khi ch·∫°y code...</p>
            `
        };

        const quillInstance = mode === 'edit' ? editLessonQuill : addLessonQuill;
        if (quillInstance && templates[type]) {
            // Get current selection/cursor position
            const selection = quillInstance.getSelection();
            const index = selection ? selection.index : quillInstance.getLength();
            
            // Insert template at cursor position
            quillInstance.clipboard.dangerouslyPasteHTML(index, templates[type]);
            
            // Move cursor to end of inserted content
            const newIndex = index + templates[type].length;
            quillInstance.setSelection(newIndex, 0);
        }
    }

   

   

    

       

 

    // Video preview function
    function previewVideo(inputId, previewId) {
        const input = document.getElementById(inputId);
        const preview = document.getElementById(previewId);
        const videoUrl = input.value.trim();
        
        // If no URL, hide the preview completely
        if (!videoUrl) {
            preview.style.display = 'none';
            return;
        }
        
        const videoPreview = preview.querySelector('.video-preview');
        let embedUrl = '';
        
        // YouTube URL processing
        if (videoUrl.includes('youtube.com/watch?v=') || videoUrl.includes('youtu.be/')) {
            let videoId = '';
            if (videoUrl.includes('youtube.com/watch?v=')) {
                videoId = videoUrl.split('v=')[1].split('&')[0];
            } else if (videoUrl.includes('youtu.be/')) {
                videoId = videoUrl.split('youtu.be/')[1].split('?')[0];
            }
            embedUrl = `https://www.youtube.com/embed/${videoId}`;
        }
        // Vimeo URL processing
        else if (videoUrl.includes('vimeo.com/')) {
            const videoId = videoUrl.split('vimeo.com/')[1].split('?')[0];
            embedUrl = `https://player.vimeo.com/video/${videoId}`;
        }
        // Direct video URL
        else if (videoUrl.match(/\.(mp4|webm|ogg)$/i)) {
            videoPreview.innerHTML = `<video controls style="width: 100%; height: 100%;"><source src="${videoUrl}" type="video/mp4">Your browser does not support the video tag.</video>`;
            preview.style.display = 'block';
            return;
        }
        
        if (embedUrl) {
            videoPreview.innerHTML = `<iframe src="${embedUrl}" frameborder="0" allowfullscreen></iframe>`;
            preview.style.display = 'block';
        } else {
            videoPreview.innerHTML = `
                <div class="video-preview-placeholder">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>URL video kh√¥ng h·ª£p l·ªá</span>
                    <small>H·ªó tr·ª£: YouTube, Vimeo, ho·∫∑c file video tr·ª±c ti·∫øp (.mp4, .webm, .ogg)</small>
                </div>
            `;
            preview.style.display = 'block';
        }
    }

    // Toggle module function
    function toggleModule(element) {
        const moduleContent = element.nextElementSibling;
        const toggle = element.querySelector('.module-toggle');
        
        if (moduleContent.classList.contains('expanded')) {
            moduleContent.classList.remove('expanded');
                toggle.textContent = '+';
            } else {
            moduleContent.classList.add('expanded');
                toggle.textContent = '‚àí';
            }
        }

    // Expand all modules function
    function expandAllModules() {
        const expandBtn = document.querySelector('.expand-all');
        const moduleContents = document.querySelectorAll('.module-content');
        const toggles = document.querySelectorAll('.module-toggle');
        
        const isExpanded = expandBtn.textContent.includes('Thu g·ªçn');
        
        moduleContents.forEach(content => {
            if (isExpanded) {
                content.classList.remove('expanded');
            } else {
                content.classList.add('expanded');
            }
        });
        
        toggles.forEach(toggle => {
            toggle.textContent = isExpanded ? '+' : '‚àí';
        });
        
        expandBtn.innerHTML = isExpanded ? 
            '<i class="fas fa-expand-arrows-alt"></i> M·ªü r·ªông t·∫•t c·∫£' : 
            '<i class="fas fa-compress-arrows-alt"></i> Thu g·ªçn t·∫•t c·∫£';
    }

    // Submit lesson function
    async function submitLesson(event) {
        event.preventDefault();
        
        const submitBtn = document.getElementById('submitBtn');
        const originalText = submitBtn.innerHTML;
        
        try {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang t·∫°o...';
            
            // Get form data
            const formData = new FormData(event.target);
            
            // Get content from Quill editor
            if (addLessonQuill) {
                const contentHtml = addLessonQuill.root.innerHTML;
                formData.set('contentHtml', contentHtml);
            }
            
            // Get course ID from URL or data attribute
            const courseId = document.body.getAttribute('data-course-id') || 
                           window.location.pathname.match(/\/courses?\/([^\/]+)/)?.[1];
            
            console.log('üîç Debug courseId extraction:');
            console.log('  - data-course-id:', document.body.getAttribute('data-course-id'));
            console.log('  - URL pathname:', window.location.pathname);
            console.log('  - URL match result:', window.location.pathname.match(/\/courses?\/([^\/]+)/));
            console.log('  - Final courseId:', courseId);
            
            if (!courseId) {
                throw new Error('Kh√¥ng t√¨m th·∫•y ID kh√≥a h·ªçc');
            }
            
            // Convert FormData to JSON object
            const lessonData = {};
            for (let [key, value] of formData.entries()) {
                lessonData[key] = value;
            }
            
            // Get JWT token
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            }

            const authToken = getCookie('auth_token');
            const headers = {
                'Content-Type': 'application/json'
            };

            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            console.log('Creating lesson with data:', lessonData);
            console.log('Course ID:', courseId);
            console.log('Endpoint:', `/api/courses/${courseId}/lessons`);

            const response = await fetch(`/api/courses/${courseId}/lessons`, {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(lessonData)
            });

            if (response.ok) {
                // alert('‚úÖ B√†i h·ªçc ƒë√£ ƒë∆∞·ª£c t·∫°o th√†nh c√¥ng!');
                hideAddLessonModal();
                window.location.reload();
            } else {
                const errorText = await response.text();
                let errorMessage = 'C√≥ l·ªói x·∫£y ra khi t·∫°o b√†i h·ªçc';
                
                try {
                    const errorData = JSON.parse(errorText);
                    errorMessage = errorData.error || errorData.message || errorMessage;
                } catch (e) {
                    errorMessage = errorText || errorMessage;
                }
                
                throw new Error(errorMessage);
            }
        } catch (error) {
            console.error('Error creating lesson:', error);
            alert('‚ùå L·ªói: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    }

    // Update lesson function
    async function updateLesson(event) {
        event.preventDefault();
        
        const updateBtn = document.getElementById('updateBtn');
        const originalText = updateBtn.innerHTML;
        
        try {
            updateBtn.disabled = true;
            updateBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang c·∫≠p nh·∫≠t...';
            
            // Get form data
            const formData = new FormData(event.target);
            const lessonId = document.getElementById('editLessonId').value;
            
            // Get content from Quill editor
            if (editLessonQuill) {
                const contentHtml = editLessonQuill.root.innerHTML;
                formData.set('contentHtml', contentHtml);
            }
            
            // Convert FormData to JSON object
            const lessonData = {};
            for (let [key, value] of formData.entries()) {
                lessonData[key] = value;
            }
            
            // Get JWT token
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            }

            const authToken = getCookie('auth_token');
            const headers = {
                'Content-Type': 'application/json'
            };

            if (authToken) {
                headers['Authorization'] = `Bearer ${authToken}`;
            }

            console.log('Updating lesson with data:', lessonData);
            console.log('Lesson ID:', lessonId);
            console.log('Endpoint:', `/api/lessons/${lessonId}`);

            const response = await fetch(`/api/lessons/${lessonId}`, {
                method: 'PUT',
                headers: headers,
                body: JSON.stringify(lessonData)
            });

            if (response.ok) {
                // alert('‚úÖ B√†i h·ªçc ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t th√†nh c√¥ng!');
                hideEditLessonModal();
                window.location.reload();
            } else {
                const errorText = await response.text();
                let errorMessage = 'C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t b√†i h·ªçc';
                
                try {
                    const errorData = JSON.parse(errorText);
                    errorMessage = errorData.error || errorData.message || errorMessage;
                } catch (e) {
                    errorMessage = errorText || errorMessage;
                }
                
                throw new Error(errorMessage);
            }
        } catch (error) {
            console.error('Error updating lesson:', error);
            alert('‚ùå L·ªói: ' + error.message);
        } finally {
            updateBtn.disabled = false;
            updateBtn.innerHTML = originalText;
        }
    }

    // Submit comment function
    async function submitComment(event) {
        event.preventDefault();
        
        const content = document.getElementById('comment-content').value.trim();
        const rating = document.getElementById('rating-value').value;
        
        if (!content) {
            alert('Vui l√≤ng nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n');
            return;
        }
        
        if (!rating || rating === '0') {
            alert('Vui l√≤ng ch·ªçn s·ªë sao ƒë√°nh gi√°');
            return;
        }

        try {
            const response = await fetch('/api/comments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include', // Include cookies for session-based auth
                body: JSON.stringify({
                    courseId: courseId,
                    content: content,
                    rating: parseInt(rating)
                })
            });

            if (response.ok) {
                // Reset form
                document.getElementById('comment-content').value = '';
                document.getElementById('rating-value').value = '0';
                currentRating = 0;
                updateStarDisplay(document.querySelectorAll('.star-input'), 0);
                
                // Reload comments and stats
                loadComments();
                loadRatingStats();
                // Removed success alert popup for cleaner UI
            } else {
                const errorData = await response.json();
                alert('L·ªói: ' + (errorData.error || 'Kh√¥ng th·ªÉ g·ª≠i b√¨nh lu·∫≠n'));
            }
        } catch (error) {
            console.error('Error submitting comment:', error);
            alert('L·ªói khi g·ª≠i b√¨nh lu·∫≠n');
        }
    }

    // Load comments function
    async function loadComments() {
        const commentsList = document.getElementById('comments-list');
        const loading = document.getElementById('comments-loading');
        
        if (!courseId || courseId.trim() === '') {
            console.error('CourseId is empty, cannot load comments');
            if (commentsList) {
                commentsList.innerHTML = '<div class="error">Kh√¥ng th·ªÉ t·∫£i b√¨nh lu·∫≠n: Thi·∫øu th√¥ng tin kh√≥a h·ªçc</div>';
            }
            return;
        }
        
        try {
            if (loading) {
                loading.style.display = 'block';
            }
            
            const response = await fetch(`/api/comments/course/${courseId}`);
            
            if (response.ok) {
                const comments = await response.json();
                displayComments(comments);
            } else {
                throw new Error('Kh√¥ng th·ªÉ t·∫£i b√¨nh lu·∫≠n');
            }
        } catch (error) {
            console.error('Error loading comments:', error);
            if (commentsList) {
                commentsList.innerHTML = '<div class="error">L·ªói khi t·∫£i b√¨nh lu·∫≠n</div>';
            }
        } finally {
            if (loading) {
                loading.style.display = 'none';
            }
        }
    }

    // Load rating stats function
    async function loadRatingStats() {
        if (!courseId || courseId.trim() === '') {
            console.error('CourseId is empty, cannot load rating stats');
            return;
        }
        
        try {
            const response = await fetch(`/api/comments/course/${courseId}/stats`);
            
            if (response.ok) {
                const stats = await response.json();
                displayRatingStats(stats);
            } else {
                console.error('Failed to load rating stats');
            }
        } catch (error) {
            console.error('Error loading rating stats:', error);
        }
    }

    // Display comments function
    function displayComments(comments) {
        const commentsList = document.getElementById('comments-list');
        
        if (!commentsList) {
            console.error('Comments list element not found');
            return;
        }
        
        if (!comments || comments.length === 0) {
            commentsList.innerHTML = '<div class="no-comments">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o cho kh√≥a h·ªçc n√†y</div>';
            return;
        }
        
        // Use updated global variables
        const userLoggedIn = isUserLoggedIn;
        const userRole = currentUserRole;
        
        console.log('üîç Displaying comments with user info:', {
            isUserLoggedIn: isUserLoggedIn,
            userLoggedIn: userLoggedIn,
            role: userRole,
            userId: currentUserId,
            commentsCount: comments.length
        });
        
        const commentsHtml = comments.map(comment => {
            console.log('üîç Processing comment:', comment.id, 'for user:', {
                loggedIn: userLoggedIn,
                role: userRole
            });
            
            let userRoleBadge = '';
            if (comment.userRole === 'TEACHER') {
                userRoleBadge = '<span class="user-role-badge teacher">Gi·∫£ng vi√™n</span>';
            } else if (comment.userRole === 'ADMIN') {
                userRoleBadge = '<span class="user-role-badge admin">Qu·∫£n tr·ªã</span>';
            }
            
            const stars = '‚òÖ'.repeat(comment.rating) + '‚òÜ'.repeat(5 - comment.rating);
            const commentDate = new Date(comment.createdAt).toLocaleDateString('vi-VN');
            
            let repliesHtml = '';
            if (comment.replies && comment.replies.length > 0) {
                repliesHtml = `
                    <div class="replies-container">
                        ${comment.replies.map(reply => {
                            let replyUserRoleBadge = '';
                            if (reply.userRole === 'TEACHER') {
                                replyUserRoleBadge = '<span class="user-role-badge teacher">Gi·∫£ng vi√™n</span>';
                            } else if (reply.userRole === 'ADMIN') {
                                replyUserRoleBadge = '<span class="user-role-badge admin">Qu·∫£n tr·ªã</span>';
                            }
                            
                            const replyDate = new Date(reply.createdAt).toLocaleDateString('vi-VN');
                            return `
                                <div class="reply-item">
                                    <div class="comment-header">
                                        <div class="comment-user-info">
                                            <strong>${reply.userName}</strong>
                                            ${replyUserRoleBadge}
                                        </div>
                                        <span class="comment-date">${replyDate}</span>
                                    </div>
                                    <div class="comment-content">${reply.content}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }
            
            // Show menu for logged-in users
            let commentMenu = '';
            
            if (userLoggedIn) {
                console.log('‚úÖ User is logged in, creating menu for comment:', comment.id);
                
                let menuOptions = '';
                
                // Always show reply option for logged-in users
                menuOptions += `
                    <button class="menu-item reply" onclick="showReplyForm('${comment.id}')">
                        <i class="fas fa-reply"></i> Tr·∫£ l·ªùi
                    </button>
                `;
                
                // Show delete option for TEACHER and ADMIN
                if (userRole === 'TEACHER' || userRole === 'ADMIN') {
                    console.log('‚úÖ Adding delete option for role:', userRole);
                    menuOptions += `
                        <button class="menu-item delete" onclick="deleteComment('${comment.id}', '${comment.userName}')">
                            <i class="fas fa-trash"></i> X√≥a
                        </button>
                    `;
                }
                
                commentMenu = `
                    <div class="comment-menu" style="display: inline-block !important; visibility: visible !important;">
                        <button class="menu-toggle" onclick="toggleCommentMenu('${comment.id}')" title="T√πy ch·ªçn" 
                                style="display: flex !important; visibility: visible !important; opacity: 1 !important; 
                                       background: #667eea !important; color: white !important; border: none !important;">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="menu-dropdown" id="menu-${comment.id}">
                            ${menuOptions}
                        </div>
                    </div>
                `;
                
                console.log('‚úÖ Menu created for comment:', comment.id);
            } else {
                console.log('‚ùå User not logged in, no menu for comment:', comment.id);
            }
            
            return `
                <div class="comment-item">
                    <div class="comment-header">
                        <div class="comment-user-info">
                            <strong>${comment.userName}</strong>
                            ${userRoleBadge}
                        </div>
                        <div class="comment-meta">
                            <span class="comment-rating">${stars}</span>
                            <span class="comment-date">${commentDate}</span>
                            ${commentMenu}
                        </div>
                    </div>
                    <div class="comment-content">${comment.content}</div>
                    <div class="reply-form" id="reply-form-${comment.id}">
                        <textarea class="reply-input" placeholder="Nh·∫≠p ph·∫£n h·ªìi c·ªßa b·∫°n..."></textarea>
                        <div class="reply-actions">
                            <button class="reply-cancel" onclick="hideReplyForm('${comment.id}')">H·ªßy</button>
                            <button class="reply-submit" onclick="submitReply('${comment.id}')">G·ª≠i</button>
                        </div>
                    </div>
                    ${repliesHtml}
                </div>
            `;
        }).join('');
        
        commentsList.innerHTML = commentsHtml;
        
        console.log('‚úÖ Comments displayed successfully');
        console.log('‚úÖ Total comments:', comments.length);
    }

    // Display rating stats function
    function displayRatingStats(stats) {
        const ratingSummary = document.getElementById('rating-summary');
        
        if (!ratingSummary) {
            console.error('Rating summary element not found');
            return;
        }
        
        const averageRating = stats.averageRating || 0;
        const totalComments = stats.totalComments || 0;
        const ratingBreakdown = stats.ratingBreakdown || {};
        
        // Update average rating display
        const ratingNumber = ratingSummary.querySelector('.rating-number');
        const ratingStars = ratingSummary.querySelectorAll('.rating-stars .star');
        const ratingCount = ratingSummary.querySelector('.rating-count');
        
        if (ratingNumber) {
            ratingNumber.textContent = averageRating.toFixed(1);
        }
        if (ratingCount) {
            ratingCount.textContent = `${totalComments} ƒë√°nh gi√°`;
        }
        
        // Update stars display
        if (ratingStars && ratingStars.length > 0) {
            ratingStars.forEach((star, index) => {
                if (index < Math.floor(averageRating)) {
                    star.style.color = '#ffd700';
                } else if (index < averageRating) {
                    star.style.color = '#ffd700';
                    star.style.opacity = '0.5';
                } else {
                    star.style.color = '#e9ecef';
                }
            });
        }
        
        // Update rating breakdown
        for (let rating = 1; rating <= 5; rating++) {
            const count = ratingBreakdown[rating] || 0;
            const percentage = totalComments > 0 ? (count / totalComments * 100) : 0;
            
            const ratingFill = ratingSummary.querySelector(`[data-rating="${rating}"]`);
            const ratingPercent = ratingFill ? ratingFill.parentElement.nextElementSibling : null;
            
            if (ratingFill) {
                ratingFill.style.width = percentage + '%';
            }
            if (ratingPercent) {
                ratingPercent.textContent = Math.round(percentage) + '%';
            }
        }
    }

    // Show reply form function
    function showReplyForm(commentId) {
        const replyForm = document.getElementById('reply-form-' + commentId);
        if (replyForm) {
            replyForm.classList.add('show');
            replyForm.style.display = 'block';
            console.log('Reply form shown for comment:', commentId);
        }
        
        // Close menu after clicking
        const menu = document.getElementById('menu-' + commentId);
        if (menu) {
            menu.classList.remove('show');
        }
    }

    // Hide reply form function
    function hideReplyForm(commentId) {
        const replyForm = document.getElementById('reply-form-' + commentId);
        if (replyForm) {
            replyForm.classList.remove('show');
            replyForm.style.display = 'none';
            // Clear the textarea
            const textarea = replyForm.querySelector('.reply-input');
            if (textarea) {
                textarea.value = '';
            }
        }
    }

    // Submit reply function
    async function submitReply(commentId) {
        const replyForm = document.getElementById('reply-form-' + commentId);
        const textarea = replyForm.querySelector('.reply-input');
        const content = textarea.value.trim();
        
        if (!content) {
            alert('Vui l√≤ng nh·∫≠p n·ªôi dung ph·∫£n h·ªìi');
            return;
        }
        
        try {
            const response = await fetch(`/api/comments/${commentId}/reply`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    content: content
                })
            });
            
            if (response.ok) {
                // Removed success alert popup for cleaner UI
                hideReplyForm(commentId);
                loadComments(); // Reload comments to show the new reply
            } else {
                const errorData = await response.json();
                alert('L·ªói: ' + (errorData.error || 'Kh√¥ng th·ªÉ g·ª≠i ph·∫£n h·ªìi'));
            }
        } catch (error) {
            console.error('Error submitting reply:', error);
            alert('L·ªói khi g·ª≠i ph·∫£n h·ªìi');
        }
    }

    // L·∫•y courseId t·ª´ URL ho·∫∑c t·ª´ Thymeleaf
    let courseId = '';
    
    // Method 1: Try to get courseId from data attribute (most reliable)
    const bodyElement = document.body;
    const dataCourseId = bodyElement.getAttribute('data-course-id');
    console.log('üîç CourseId from data attribute:', dataCourseId);
    
    if (dataCourseId && dataCourseId.trim() !== '') {
        courseId = dataCourseId.trim();
        console.log('‚úÖ Using CourseId from data attribute:', courseId);
    } else {
        // Method 2: Try to get courseId from Thymeleaf
        const thymeleafCourseId = /*[[${course != null ? course.id : ''}]]*/ '';
        console.log('üîç CourseId from Thymeleaf:', thymeleafCourseId);
        
        if (thymeleafCourseId && thymeleafCourseId.trim() !== '') {
            courseId = thymeleafCourseId.trim();
            console.log('‚úÖ Using CourseId from Thymeleaf:', courseId);
        } else {
            // Method 3: If courseId is empty from Thymeleaf, try to extract from URL
            const urlPath = window.location.pathname;
            console.log('üîç Current URL path:', urlPath);
            
            // Pattern: /course/{courseId}/lessons
            const courseIdMatch = urlPath.match(/\/course\/([^\/]+)\/lessons/);
            if (courseIdMatch && courseIdMatch[1]) {
                courseId = courseIdMatch[1];
                console.log('‚úÖ CourseId extracted from URL:', courseId);
            } else {
                // Try alternative pattern: /courses/{courseId}
                const altCourseIdMatch = urlPath.match(/\/courses\/([^\/]+)/);
                if (altCourseIdMatch && altCourseIdMatch[1]) {
                    courseId = altCourseIdMatch[1];
                    console.log('‚úÖ CourseId extracted from alternative URL pattern:', courseId);
                } else {
                    console.error('‚ùå Could not extract courseId from URL');
                }
            }
        }
    }

    // Add expand all functionality
    document.addEventListener('DOMContentLoaded', function() {
        const expandAllBtn = document.querySelector('.expand-all');
        if (expandAllBtn) {
            expandAllBtn.addEventListener('click', expandAllModules);
        }
    });

    // Initialize comments system when comments tab is shown
    if (typeof courseId !== 'undefined' && courseId) {
        loadComments();
        loadRatingStats();
    }

    // Suppress DOMNodeInserted deprecation warnings (from browser extensions or libraries)
    const originalConsoleWarn = console.warn;
    console.warn = function(...args) {
        if (args[0] && typeof args[0] === 'string' && 
            (args[0].includes('DOMNodeInserted') || args[0].includes('mutation event'))) {
            // Suppress DOMNodeInserted warnings
            return;
        }
        originalConsoleWarn.apply(console, args);
    };

    // Toggle comment menu function
    function toggleCommentMenu(commentId) {
        const menu = document.getElementById(`menu-${commentId}`);
        const allMenus = document.querySelectorAll('.menu-dropdown');
        
        // Close all other menus
        allMenus.forEach(m => {
            if (m !== menu) {
                m.classList.remove('show');
            }
        });
        
        // Toggle current menu
        if (menu) {
            menu.classList.toggle('show');
        }
    }

    // Close menus when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.comment-menu')) {
            const allMenus = document.querySelectorAll('.menu-dropdown');
            allMenus.forEach(menu => {
                menu.classList.remove('show');
            });
        }
    });

    // Delete comment function
    async function deleteComment(commentId, commentUserName) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a b√¨nh lu·∫≠n c·ªßa ${commentUserName}?\n\nH√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c!`)) {
            return;
        }
        
        try {
            const authCheck = await fetch('/api/auth/check');
            const authStatus = await authCheck.json();
            
            if (!authStatus.authenticated) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ x√≥a b√¨nh lu·∫≠n');
                return;
            }
            
            const response = await fetch(`/api/comments/${commentId}`, {
                method: 'DELETE',
                credentials: 'include'
            });
            
            if (response.ok) {
                alert('B√¨nh lu·∫≠n ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!');
                loadComments(); // Reload comments
                loadRatingStats(); // Reload rating stats
            } else {
                const errorData = await response.json();
                alert('L·ªói: ' + (errorData.error || 'Kh√¥ng th·ªÉ x√≥a b√¨nh lu·∫≠n'));
            }
        } catch (error) {
            console.error('Error deleting comment:', error);
            alert('L·ªói khi x√≥a b√¨nh lu·∫≠n');
        }
        
        // Close menu after clicking
        const menu = document.getElementById('menu-' + commentId);
        if (menu) {
            menu.classList.remove('show');
        }
    }

    // Close menus when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.comment-menu')) {
            document.querySelectorAll('.menu-dropdown').forEach(dropdown => {
                dropdown.classList.remove('show');
            });
        }
    });

   
    
    
    
   
    // Get Auth Token
    function getAuthToken() {
        const token = localStorage.getItem('authToken') || sessionStorage.getItem('authToken');
        return token ? `Bearer ${token}` : '';
    }

    

    // Add CSS animations for notifications
    const notificationStyle = document.createElement('style');
    notificationStyle.textContent = `
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(notificationStyle);


    
  
    

    
   

    // üî• REAL-TIME COMMENTS: WebSocket Setup
    let commentSocket = null;
    let isCommentSocketConnected = false;
    
    function connectCommentWebSocket() {
        try {
            console.log('üîó Connecting to comment WebSocket...');
            
            // Use SockJS for WebSocket connection (same as chat system)
            const socket = new SockJS('/ws');
            commentSocket = Stomp.over(socket);
            
            // Disable debug logging
            commentSocket.debug = null;
            
            commentSocket.connect({}, function(frame) {
                console.log('‚úÖ Comment WebSocket connected:', frame);
                isCommentSocketConnected = true;
                
                // Subscribe to this course's comment updates
                const courseId = getCurrentCourseId();
                if (courseId) {
                    console.log('üìù Subscribing to course comments:', courseId);
                    subscribeToCommentUpdates(courseId);
                }
            }, function(error) {
                console.error('‚ùå Comment WebSocket connection error:', error);
                isCommentSocketConnected = false;
                
                // Reconnect after 3 seconds
                setTimeout(connectCommentWebSocket, 3000);
            });
            
        } catch (error) {
            console.error('‚ùå Error connecting comment WebSocket:', error);
            isCommentSocketConnected = false;
        }
    }
    
    function subscribeToCommentUpdates(courseId) {
        if (!isCommentSocketConnected || !commentSocket) {
            console.log('‚ö†Ô∏è Comment WebSocket not connected, cannot subscribe');
            return;
        }
        
        try {
            // Subscribe to comment updates for this course
            commentSocket.subscribe(`/topic/course/${courseId}/comments`, function(message) {
                try {
                    const data = JSON.parse(message.body);
                    console.log('üì® Comment update received:', data);
                    handleCommentUpdate(data);
                } catch (error) {
                    console.error('‚ùå Error parsing comment update:', error);
                }
            });
            
            // Subscribe to rating stats updates
            commentSocket.subscribe(`/topic/course/${courseId}/rating-stats`, function(message) {
                try {
                    const data = JSON.parse(message.body);
                    console.log('üìä Rating stats update received:', data);
                    handleCommentUpdate(data);
                } catch (error) {
                    console.error('‚ùå Error parsing rating stats update:', error);
                }
            });
            
            console.log('üì° Subscribed to course comment updates:', courseId);
        } catch (error) {
            console.error('‚ùå Error subscribing to comment updates:', error);
        }
    }
    
    function handleCommentUpdate(data) {
        console.log('üîÑ Handling comment update:', data);
        
        if (data.action === 'reload_comments') {
            // Show notification
            showCommentNotification(data);
            
            // Reload comments automatically
            setTimeout(() => {
                loadComments();
            }, 500);
        } else if (data.action === 'update_rating_stats') {
            // Update rating stats in real-time
            updateRatingStatsDisplay(data.stats);
        }
    }
    
    function showCommentNotification(data) {
        let message = '';
        let icon = '';
        
        switch (data.type) {
            case 'NEW_COMMENT':
                message = `üí¨ ${data.comment.userName} v·ª´a th√™m b√¨nh lu·∫≠n m·ªõi`;
                icon = 'üí¨';
                break;
            case 'NEW_REPLY':
                message = `üí≠ ${data.reply.userName} v·ª´a tr·∫£ l·ªùi b√¨nh lu·∫≠n`;
                icon = 'üí≠';
                break;
            case 'COMMENT_DELETED':
                message = 'üóëÔ∏è M·ªôt b√¨nh lu·∫≠n ƒë√£ b·ªã x√≥a';
                icon = 'üóëÔ∏è';
                break;
            default:
                message = 'üîÑ B√¨nh lu·∫≠n ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t';
                icon = 'üîÑ';
        }
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = 'comment-notification';
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-icon">${icon}</span>
                <span class="notification-message">${message}</span>
            </div>
        `;
        
        // Add notification styles
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideInRight 0.3s ease-out;
            max-width: 300px;
            font-size: 14px;
        `;
        
        document.body.appendChild(notification);
        
        // Remove notification after 4 seconds
        setTimeout(() => {
            notification.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }, 4000);
    }
    
    function updateRatingStatsDisplay(stats) {
        try {
            // Update average rating display
            const avgRatingElement = document.querySelector('.avg-rating');
            if (avgRatingElement && stats.averageRating) {
                avgRatingElement.textContent = stats.averageRating.toFixed(1);
            }
            
            // Update total comments count
            const totalCommentsElement = document.querySelector('.total-comments');
            if (totalCommentsElement && stats.totalComments) {
                totalCommentsElement.textContent = stats.totalComments;
            }
            
            // Update rating breakdown if exists
            if (stats.ratingBreakdown) {
                for (let rating = 1; rating <= 5; rating++) {
                    const ratingElement = document.querySelector(`.rating-${rating}-count`);
                    if (ratingElement) {
                        ratingElement.textContent = stats.ratingBreakdown[rating] || 0;
                    }
                }
            }
            
            console.log('üìä Rating stats updated:', stats);
        } catch (error) {
            console.error('‚ùå Error updating rating stats:', error);
        }
    }
    
    function getCurrentCourseId() {
        // Try to get course ID from various sources
        const urlParams = new URLSearchParams(window.location.search);
        let courseId = urlParams.get('courseId');
        
        if (!courseId) {
            // Try to get from URL path
            const pathParts = window.location.pathname.split('/');
            const courseIndex = pathParts.indexOf('course');
            if (courseIndex !== -1 && courseIndex + 1 < pathParts.length) {
                courseId = pathParts[courseIndex + 1];
            }
        }
        
        if (!courseId) {
            // Try to get from hidden input or data attribute
            const courseIdInput = document.querySelector('input[name="courseId"]');
            if (courseIdInput) {
                courseId = courseIdInput.value;
            }
        }
        
        if (!courseId) {
            // Try to get from page data
            const courseIdElement = document.querySelector('[data-course-id]');
            if (courseIdElement) {
                courseId = courseIdElement.getAttribute('data-course-id');
            }
        }
        
        console.log('üéØ Current course ID:', courseId);
        return courseId;
    }
    
    // Initialize real-time comments when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Initializing real-time comments...');
        
        // Connect WebSocket for real-time comments
        setTimeout(() => {
            connectCommentWebSocket();
        }, 1000);
    });
    
    // Reconnect WebSocket when window regains focus
    window.addEventListener('focus', function() {
        if (!isCommentSocketConnected) {
            console.log('üîÑ Window focused, reconnecting comment WebSocket...');
            connectCommentWebSocket();
        }
    });

    // Disconnect WebSocket when page is unloaded
    window.addEventListener('beforeunload', function() {
        if (commentSocket && isCommentSocketConnected) {
            console.log('üîå Disconnecting comment WebSocket...');
            commentSocket.disconnect();
            isCommentSocketConnected = false;
        }
    });

    
   
</script>
</body>
</html>